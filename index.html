<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz do nauki</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .quiz-container {
      background: #ffffff;
      width: 100%;
      max-width: 600px;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 28px;
      text-align: center;
      margin-bottom: 20px;
    }

    .question {
      font-size: 22px;
      margin-bottom: 20px;
      white-space: pre-wrap;
    }

    .answers button {
      width: 100%;
      padding: 14px;
      margin-bottom: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: 2px solid #ccc;
      background: #fff;
      cursor: pointer;
    }

    .answers button.correct {
      background: #28a745;
      color: #fff;
      border-color: #28a745;
    }

    .answers button.wrong {
      background: #dc3545;
      color: #fff;
      border-color: #dc3545;
    }

    .next-btn {
      width: 100%;
      padding: 16px;
      font-size: 20px;
      border: none;
      border-radius: 10px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      margin-top: 10px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      font-size: 18px;
      padding: 10px;
      border-radius: 8px;
      border: 2px solid #ccc;
      box-sizing: border-box;
      resize: vertical;
    }

    .feedback {
      font-size: 18px;
      margin-top: 10px;
      white-space: pre-wrap;
    }

    .result {
      font-size: 26px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="quiz-container">
    <h1>Quiz do nauki</h1>
    <div id="quiz"></div>
  </div>

<script>
let allQuestions = [];
let questions = [];
let currentQuestion = 0;
let score = 0;
let wrongQuestions = []; // tablica pyta≈Ñ ≈∫le rozwiƒÖzanych

const quizEl = document.getElementById("quiz");

/* ================= CSV ================= */
fetch("questions.csv")
  .then(r => r.text())
  .then(text => {
    const lines = text
      .replace(/^\uFEFF/, "")
      .split(/\r?\n/)
      .filter(l => l.trim());

    lines.slice(1).forEach(line => {
      const p = line.split(";");

      if (p[0] === "multiple") {
        const answers = p.slice(2,6).map(a => a.replace(/^"|"$/g,"").trim());
        const correct = p[6]?.replace(/^"|"$/g,"").trim();

        allQuestions.push({
          type: "multiple",
          question: p[1].replace(/\\n/g,"\n"),
          answers,
          correct: answers.indexOf(correct)
        });

      } else if (p[0] === "open") {
        const correct = p.slice(6).join(";")
          .replace(/^"|"$/g,"")
          .replace(/\\n/g,"\n")
          .trim();

        allQuestions.push({
          type: "open",
          question: p[1].replace(/\\n/g,"\n"),
          correct
        });
      }
    });

    showStartScreen();
  });

/* ================= START ================= */
function showStartScreen() {
  quizEl.innerHTML = `
    <h2>Wybierz tryb</h2>
    <button class="next-btn" onclick="startAll()">üìò Test z ca≈Çej bazy</button>
    <button class="next-btn" onclick="startExam()">üìù Egzamin (40 losowych pyta≈Ñ)</button>
  `;
}

function startAll() {
  questions = [...allQuestions];
  wrongQuestions = [];
  startQuiz();
}

function startExam() {
  questions = shuffle([...allQuestions]).slice(0, 40);
  wrongQuestions = [];
  startQuiz();
}

function startQuiz() {
  currentQuestion = 0;
  score = 0;
  showQuestion();
}

/* ================= QUIZ ================= */
function normalizeLines(str) {
  return str
    .replace(/\r\n/g,"\n")
    .replace(/\r/g,"\n")
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean);
}

function compareAnswers(user, correct) {
  const u = normalizeLines(user);
  const c = normalizeLines(correct);
  if (u.length !== c.length) return false;
  return u.every((l,i) => l.toLowerCase() === c[i].toLowerCase());
}

function showQuestion() {
  const q = questions[currentQuestion];
  quizEl.innerHTML = "";

  const qEl = document.createElement("div");
  qEl.className = "question";
  qEl.textContent = `${currentQuestion + 1}/${questions.length}\n\n${q.question}`;
  quizEl.appendChild(qEl);

  if (q.type === "multiple") {
    const ansEl = document.createElement("div");
    ansEl.className = "answers";

    q.answers.forEach((a,i) => {
      if (!a) return;
      const b = document.createElement("button");
      b.textContent = a;
      b.onclick = () => checkMultiple(b,i);
      ansEl.appendChild(b);
    });

    quizEl.appendChild(ansEl);
  }

  if (q.type === "open") {
    const ta = document.createElement("textarea");

    const checkBtn = document.createElement("button");
    checkBtn.textContent = "Sprawd≈∫";
    checkBtn.className = "next-btn";

    const feedback = document.createElement("div");
    feedback.className = "feedback";

    checkBtn.onclick = () => {
      ta.disabled = true;
      checkBtn.disabled = true;

      if (compareAnswers(ta.value, q.correct)) {
        checkBtn.style.background = "#28a745";
        checkBtn.textContent = "‚úî Poprawnie";
        feedback.style.color = "#28a745";
        feedback.textContent = "Dobra odpowied≈∫!";
        score++;
      } else {
        checkBtn.style.background = "#dc3545";
        checkBtn.textContent = "‚úñ ≈πle";
        feedback.style.color = "#dc3545";
        feedback.textContent = "Poprawna odpowied≈∫:\n" + q.correct;
        wrongQuestions.push(q); // zapisanie do powt√≥rki
      }

      const next = document.createElement("button");
      next.textContent = "Dalej";
      next.className = "next-btn";
      next.onclick = nextQuestion;

      quizEl.appendChild(feedback);
      quizEl.appendChild(next);
    };

    quizEl.appendChild(ta);
    quizEl.appendChild(checkBtn);
  }
}

function checkMultiple(btn,i) {
  const q = questions[currentQuestion];
  document.querySelectorAll(".answers button").forEach(b => b.disabled = true);

  if (i === q.correct) {
    btn.classList.add("correct");
    score++;
  } else {
    btn.classList.add("wrong");
    document.querySelectorAll(".answers button")[q.correct].classList.add("correct");
    wrongQuestions.push(q); // zapisanie pytania do powt√≥rki
  }

  const next = document.createElement("button");
  next.textContent = "Dalej";
  next.className = "next-btn";
  next.onclick = nextQuestion;
  quizEl.appendChild(next);
}

function nextQuestion() {
  currentQuestion++;
  currentQuestion < questions.length ? showQuestion() : showResult();
}

function showResult() {
  let html = `
    <div class="result">Tw√≥j wynik: ${score}/${questions.length}</div>
    <button class="next-btn" onclick="showStartScreen()">üîÑ Wr√≥ƒá do menu</button>
  `;

  if (wrongQuestions.length > 0) {
    html += `<button class="next-btn" onclick="repeatWrong()">üîÅ Powt√≥rz b≈Çƒôdne odpowiedzi</button>`;
  }

  quizEl.innerHTML = html;
}

function repeatWrong() {
  questions = [...wrongQuestions];
  wrongQuestions = [];
  startQuiz();
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
</script>
</body>
</html>
